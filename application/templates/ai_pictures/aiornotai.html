{% extends "base.html" %}
{% load i18n %}
{% block content %}
  <div class="container">
    <div class="section-title">
      <h1 class="content-list__see-more">{% trans "AI or not AI game" %}</h1>
      <div>
        <p>
          {% trans "After clicking on the start button, you will have 20 seconds during which 20 images will scroll. For each image, you will need to determine whether it is real or generated by artificial intelligence. Please note that you will only have 1 second per image. At the end of the 20 seconds, you will receive your score out of 20 points. On your marks, get set, go!" %}
        </p>
        <p>
          {% blocktrans with total_quiz=statistics.total_quiz avg_score=statistics.avg_score %}
          ðŸ“ˆ Total number of quiz: <b>{{ total_quiz }}</b> / Average score: <b>{{ avg_score }}/20</b>
          {% endblocktrans %}
        </p>
      </div>
    </div>
    <br>
    <script>
    function randomSort() {
        return Math.random() - 0.5;
    }

    let imgCount = 0
    let nbSeconds = 20
    let results = []
    const data = [
    {img: 'https://thepornator.com/assets/img/aiornotai/fake/02.jpg', real:-1},{img: 'https://thepornator.com/assets/img/aiornotai/fake/05.jpg', real:-1},{img: 'https://thepornator.com/assets/img/aiornotai/fake/04.jpg', real:-1},{img: 'https://thepornator.com/assets/img/aiornotai/fake/03.jpg', real:-1},{img: 'https://thepornator.com/assets/img/aiornotai/fake/07.jpg', real:-1},{img: 'https://thepornator.com/assets/img/aiornotai/fake/09.jpg', real:-1},{img: 'https://thepornator.com/assets/img/aiornotai/fake/08.jpg', real:-1},{img: 'https://thepornator.com/assets/img/aiornotai/fake/06.jpg', real:-1},{img: 'https://thepornator.com/assets/img/aiornotai/fake/01.jpg', real:-1},{img: 'https://thepornator.com/assets/img/aiornotai/fake/10.jpg', real:-1},{img: 'https://thepornator.com/assets/img/aiornotai/real/10.jpg', real:1},{img: 'https://thepornator.com/assets/img/aiornotai/real/01.jpg', real:1},{img: 'https://thepornator.com/assets/img/aiornotai/real/06.jpg', real:1},{img: 'https://thepornator.com/assets/img/aiornotai/real/08.jpg', real:1},{img: 'https://thepornator.com/assets/img/aiornotai/real/11.jpg', real:1},{img: 'https://thepornator.com/assets/img/aiornotai/real/09.jpg', real:1},{img: 'https://thepornator.com/assets/img/aiornotai/real/07.jpg', real:1},{img: 'https://thepornator.com/assets/img/aiornotai/real/03.jpg', real:1},{img: 'https://thepornator.com/assets/img/aiornotai/real/04.jpg', real:1},{img: 'https://thepornator.com/assets/img/aiornotai/real/12.jpg', real:1},{img: 'https://thepornator.com/assets/img/aiornotai/real/05.jpg', real:1},{img: 'https://thepornator.com/assets/img/aiornotai/real/02.jpg', real:1},{img: 'https://thepornator.com/assets/img/aiornotai/real/13.jpg', real:1},    ]
    data.sort(randomSort);

    let imgLength = 20

    function scroll() {
        if (window.innerWidth <= 768)  position = 250;
        else position = 100;
        window.scrollTo({top: position, behavior: 'smooth'});
    }

    function start() {
        scroll();

        var intro = document.getElementById("intro");
        intro.style.display = "none";

        var frame = document.getElementById("frame");
        frame.style.display = "block";

        var result = document.getElementById("result");
        result.style.display = "none";

        var button = document.getElementById("startButton");
        button.style.display = "none";

        var icons = document.getElementById("icons");
        icons.style.display = "block";

        var progress = document.getElementById("progress");
        progress.style.display = "block";
        var progressbar = document.getElementById("progressbar");
        progressbar.style.width = "100%";

        var count = nbSeconds-1;
        var timer = setInterval(function() {
            count--;
            progressbar.style.width = ((count+1)/nbSeconds*100) + "%";
            if (count < 0) {
                clearInterval(timer);
                endGame();
            }
        }, 1000);
    }

    function addScore(score) {
        var xhr = null;
        if (window.XMLHttpRequest) {
            xhr = new XMLHttpRequest();
        } else if (window.ActiveXObject) {
            xhr = new ActiveXObject("Microsoft.XMLHTTP");
        }

        xhr.open("GET", "/php/controller.php?action=insertAiOrNotAi&score=" + score + "&date=" + Date.now(), true);
        xhr.send(null);

        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4) {
                //showMessageAndRedirect(this.responseText);
            }
        };
    }

    function endGame() {
        var button = document.getElementById("startButton");
        button.style.display = "block";
        var icons = document.getElementById("icons");
        icons.style.display = "none";
        var result = document.getElementById("result");
        let score = 0;
        for(let i = 0; i < data.length; i++) {
            if(typeof data[i] !== 'undefined' && typeof results[i] !== 'undefined' && data[i].real === results[i].real) {
                score += 1;
            }
        }
        addScore(score);
        let msg  = 'You can\'t tell the difference between a real pornographic image and an artificially generated one using artificial intelligence!';
        if (score == imgLength) msg  = 'Congratulations, you made no mistakes!';
        else if (score > imgLength *0.75) msg  = 'It\'s not perfect, but we\'re getting closer!';
        else if (score >= imgLength *0.5) msg  = 'You got a passing grade! That\'s not bad!';

        const shareUrl = 'https://thepornator.com/en/aiporn/aiornotai.html';
        const shareMessage = 'I got a score of '+score+'/'+imgLength+' at @thepornator\'s quiz, at the game "Porn AI or not Porn AI?" and you?';

        const facebookShareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}&title=${encodeURIComponent(shareMessage)}`;
        const twitterShareUrl = `https://twitter.com/intent/tweet?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(shareMessage)}`;
        const redditShareUrl = `https://www.reddit.com/submit?url=${encodeURIComponent(shareUrl)}&title=${encodeURIComponent(shareMessage)}`;

        result.innerHTML = '<h3>Your score: <b>'+score+'/'+imgLength+'</b></h3><br>'+msg +'<br>'+
                            '<br>Share your score:'+
                            '<br><a href="'+twitterShareUrl+'" target="_blank" class="btn-social btn-twitter"><i class="bx bxl-twitter"></i></a> '+
                            '<a href="'+facebookShareUrl+'" target="_blank" class="btn-social btn-facebook"><i class="bx bxl-facebook"></i></a> '+
                            '<a href="'+redditShareUrl+'" target="_blank" class="btn-social btn-reddit"><i class="bx bxl-reddit"></i></a>'+
                            '<br><br>'+
                            'Not satisfied with your score? <a href="javascript:location.reload();">Start over!</a>';
        result.style.display = "block";
        var frame = document.getElementById("frame");
        frame.style.display = "none";
        var progress = document.getElementById("progress");
        progress.style.display = "none";

        var maingame = document.getElementById("maingame");
        maingame.style.overflow = "unset";
    }
    </script>
    <div id="maingame"
         style="text-align:center;
                width:450px;
                max-width:100%;
                margin: 0 auto;
                overflow: hidden">
      <div id="intro">
        <button class="btn btn-success"
                id="startButton"
                onclick="start()"
                style="position: absolute;
                       top: 50%;
                       left: 50%;
                       transform: translate(-50%, -50%);
                       background: rgb(0 0 0 / 58%);
                       border: 4px solid #fff;
                       color: #fff;
                       font-size: 1.4rem;
                       padding: 10px 20px;
                       cursor: pointer">Start</button>
        <br>
        <img src="/assets/img/aiornotai.webp"
             style="width:100%"
             alt="game aiornotai background">
      </div>
      <div class="progress" id="progress" style="display:none;">
        <div id="progressbar"
             class="progress-bar progress-bar-striped bg-success"
             role="progressbar"
             style="width: 25%"
             aria-valuenow="25"
             aria-valuemin="0"
             aria-valuemax="100"></div>
      </div>
      <div class="frame" id="frame" style="display:none;">
        <div class="card"
             style="background-image: url(&quot;
                    https://thepornator.com/assets/img/aiornotai/fake/06.jpg&quot;
                    )">
          <div class="is-like">LIKE</div>
        </div>
        <div class="card"
             style="background-image: url(&quot;
                    https://thepornator.com/assets/img/aiornotai/fake/01.jpg&quot;
                    )">
          <div class="is-like">LIKE</div>
        </div>
        <div class="card"
             style="background-image: url(&quot;
                    https://thepornator.com/assets/img/aiornotai/fake/08.jpg&quot;
                    )">
          <div class="is-like">LIKE</div>
        </div>
        <div class="card"
             style="background-image: url(&quot;
                    https://thepornator.com/assets/img/aiornotai/real/08.jpg&quot;
                    )">
          <div class="is-like">LIKE</div>
        </div>
        <div class="card"
             style="background-image: url(&quot;
                    https://thepornator.com/assets/img/aiornotai/real/04.jpg&quot;
                    )">
          <div class="is-like">LIKE</div>
        </div>
        <div class="card"
             style="background-image: url(&quot;
                    https://thepornator.com/assets/img/aiornotai/real/01.jpg&quot;
                    )">
          <div class="is-like">LIKE</div>
        </div>
        <div class="card"
             style="background-image: url(&quot;
                    https://thepornator.com/assets/img/aiornotai/real/09.jpg&quot;
                    )">
          <div class="is-like">LIKE</div>
        </div>
        <div class="card"
             style="background-image: url(&quot;
                    https://thepornator.com/assets/img/aiornotai/real/03.jpg&quot;
                    )">
          <div class="is-like">LIKE</div>
        </div>
        <div class="card"
             style="background-image: url(&quot;
                    https://thepornator.com/assets/img/aiornotai/fake/05.jpg&quot;
                    )">
          <div class="is-like">LIKE</div>
        </div>
        <div class="card"
             style="background-image: url(&quot;
                    https://thepornator.com/assets/img/aiornotai/real/07.jpg&quot;
                    )">
          <div class="is-like">LIKE</div>
        </div>
        <div class="card"
             style="background-image: url(&quot;
                    https://thepornator.com/assets/img/aiornotai/fake/09.jpg&quot;
                    )">
          <div class="is-like">LIKE</div>
        </div>
        <div class="card"
             style="background-image: url(&quot;
                    https://thepornator.com/assets/img/aiornotai/fake/10.jpg&quot;
                    )">
          <div class="is-like">LIKE</div>
        </div>
        <div class="card"
             style="background-image: url(&quot;
                    https://thepornator.com/assets/img/aiornotai/real/11.jpg&quot;
                    )">
          <div class="is-like">LIKE</div>
        </div>
        <div class="card"
             style="background-image: url(&quot;
                    https://thepornator.com/assets/img/aiornotai/real/13.jpg&quot;
                    )">
          <div class="is-like">LIKE</div>
        </div>
        <div class="card"
             style="background-image: url(&quot;
                    https://thepornator.com/assets/img/aiornotai/real/10.jpg&quot;
                    )">
          <div class="is-like">LIKE</div>
        </div>
        <div class="card"
             style="background-image: url(&quot;
                    https://thepornator.com/assets/img/aiornotai/real/12.jpg&quot;
                    )">
          <div class="is-like">LIKE</div>
        </div>
        <div class="card"
             style="background-image: url(&quot;
                    https://thepornator.com/assets/img/aiornotai/fake/03.jpg&quot;
                    )">
          <div class="is-like">LIKE</div>
        </div>
        <div class="card"
             style="background-image: url(&quot;
                    https://thepornator.com/assets/img/aiornotai/real/05.jpg&quot;
                    )">
          <div class="is-like">LIKE</div>
        </div>
        <div class="card"
             style="background-image: url(&quot;
                    https://thepornator.com/assets/img/aiornotai/real/06.jpg&quot;
                    )">
          <div class="is-like">LIKE</div>
        </div>
        <div class="card"
             style="background-image: url(&quot;
                    https://thepornator.com/assets/img/aiornotai/fake/02.jpg&quot;
                    )">
          <div class="is-like">LIKE</div>
        </div>
      </div>
      <div class="icons" id="icons" style="display:none;">
        <button type="button" id="hate" class="btn btn-danger btnia">FAKE</button>
        <button type="button" id="like" class="btn btn-success btnia">REAL</button>
      </div>
      <div id="result" style="display:none;padding:20px;" class="listing"></div>
    </div>
    <script>
    const frame = document.body.querySelector('.frame')
    data.forEach(_data => appendCard(_data))

    let current = frame.querySelector('.card:last-child')
    let startX = 0, startY = 0, moveX = 0, moveY = 0

    initCard(current)

    document.querySelector('#like').onclick = () => {
        moveX = 1
        moveY = 0
        complete()
    }
    document.querySelector('#hate').onclick = () => {
        moveX = -1
        moveY = 0
        complete()
    }

    function appendCard(data) {
      const firstCard = frame.children[0]
      const newCard = document.createElement('div')
      newCard.className = 'card'
      newCard.style.backgroundImage = `url(${data.img})`
      newCard.innerHTML = `<div class="is-like">LIKE</div></div>`
      if (imgCount < imgLength) {
          if (firstCard) frame.insertBefore(newCard, firstCard)
          else frame.appendChild(newCard)
          imgCount++
      }
    }

    function initCard(card) {
      card.addEventListener('pointerdown', onPointerDown)
    }

    function setTransform(x, y, deg, duration) {
      current.style.transform = `translate3d(${x}px, ${y}px, 0) rotate(${deg}deg)`
      if (duration) current.style.transition = `transform ${duration}ms`
    }

    function onPointerDown({ clientX, clientY }) {
      startX = clientX
      startY = clientY
      current.addEventListener('pointermove', onPointerMove)
      current.addEventListener('pointerup', onPointerUp)
      current.addEventListener('pointerleave', onPointerUp)
    }

    function onPointerMove({ clientX, clientY }) {
      moveX = clientX - startX
      moveY = clientY - startY
      setTransform(moveX, moveY, moveX / innerWidth * 50)
    }

    function onPointerUp() {
        current.removeEventListener('pointermove', onPointerMove)
        current.removeEventListener('pointerup', onPointerUp)
        current.removeEventListener('pointerleave', onPointerUp)
        if (Math.abs(moveX) > frame.clientWidth / 2) {
            current.removeEventListener('pointerdown', onPointerDown)
            complete()
        } else {
            cancel()
        }
    }

    function complete() {
        const flyX = (Math.abs(moveX) / moveX) * innerWidth * 1.3
        const flyY = (moveY / moveX) * flyX
        setTransform(flyX, flyY, flyX / innerWidth * 50, innerWidth)

        const prev = current
        const next = current.previousElementSibling

        var real = -1
        if (moveX > 0) real = 1
        const cardStyles = window.getComputedStyle(prev);
        const backgroundImage = cardStyles.getPropertyValue('background-image');
        results.push({img:backgroundImage.slice(4, -1).replace(/"/g, ""), real:real})

        if (next) {
            initCard(next)
            current = next
            appendCard(data[imgCount % 4])
            var frame = document.getElementById("frame");
            setTimeout(() => frame.removeChild(prev), innerWidth)
        } else {
            endGame();
        }
        scroll();
    }

    function cancel() {
      setTransform(0, 0, 0, 100)
      setTimeout(() => current.style.transition = '', 100)
    }
    </script>
    <style>
    #intro {position: relative;display: inline-block;}
    .btnia {margin:10px; width: 100px;}
    #progress {margin-bottom: 20px;}
    #progressbar {width: 100%;height: 100%;}
    .frame {position: relative;width: 350px;height: 66vh;max-width: 100%;max-height: 400px;z-index: 1;margin: 0 auto;}
    .icons {margin-top: 3vh;user-select: none;position: relative;width: 350px;margin: 0 auto;text-align:center;z-index: 1;}
    .card {position: absolute;display: flex;align-items: flex-end;justify-content: center;width: 100%;height: 100%;color: #f1f1f1;border-radius: 10px;user-select: none;cursor: pointer;overflow: hidden;background-size: cover;background-repeat: no-repeat;background-position: center;touch-action: none;}
    .card .is-like {width: 100%;height: 100%;position: absolute;opacity: 0;}
    .card .is-like::after {position: absolute;left: 50%;bottom: 30%;transform: translateX(-50%) rotate(-10deg);width: 70%;height: 13%;font-size: 3em;letter-spacing: 0.2em;font-weight: 600;border-radius: 0.15em;display: flex;align-items: center;justify-content: center;}
    .card .like::after {content: "REAL";color: #4dca93;border: 0.1em solid #4dca93;}
    .card .nope::after {content: "FAKE";color: #fb4f68;border: 0.1em solid #fb4f68;}
    @media screen and (max-height: 540px) {
        .frame {width: 54vh;height: 81vh;font-size: 13px;}
    }
    @media screen and (max-height: 440px) {
        .frame {font-size: 8px;}
    }
    </style>
    <br>
  </div>
{% endblock content %}
